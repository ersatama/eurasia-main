$(document).ready(function () {

    $('#lifeInsurance-sum').maskMoney({thousands: ' ', decimal: '.', allowZero: true, suffix: ' ₸'});

    $("#lifeInsurance-date, #lifeInsurance-birth").datetimepicker({format: 'd.m.Y'});

    insurance.life();
    $("#lifeInsurance-sum").bind('keyup', function () {
        insurance.life();
    });
    $("#lifeInsurance-birth, #lifeInsurance-sex").bind('change', function () {
        insurance.life();
    });
    /*let list = {"0":"﻿18	0,298315600000000%	0,142006903703704%","1":"19	0,332577096296296%	0,148080859259259%","2":"20	0,367176903703704%	0,153335437037037%","3":"21	0,402303733333333%	0,158480503703704%","4":"22	0,438146296296296%	0,164225925925926%","5":"23	0,475161214814815%	0,171268859259259%","6":"24	0,514876755555556%	0,180255614814815%","7":"25	0,559089096296296%	0,191819792592593%","8":"26	0,609594414814815%	0,206594992592593%","9":"27	0,668188888888889%	0,225214814814815%","10":"28	0,736331851851852%	0,248182000000000%","11":"29	0,814135259259260%	0,275475851851852%","12":"30	0,901374222222222%	0,306944814814815%","13":"31	0,997823851851852%	0,342437333333333%","14":"32	1,103259259259260%	0,381801851851852%","15":"33	1,217191229629630%	0,424736562962963%","16":"34	1,338073244444440%	0,470338651851852%","17":"35	1,464094459259260%	0,517555051851852%","18":"36	1,593444029629630%	0,565332696296296%","19":"37	1,724311111111110%	0,612618518518519%","20":"38	1,855222029629630%	0,658750400000000%","21":"39	1,986051792592590%	0,704630014814815%","22":"40	2,117012577777780%	0,751549985185185%","23":"41	2,248316562962960%	0,800802933333333%","24":"42	2,380175925925930%	0,853681481481481%","25":"43	2,513610000000000%	0,911223214814815%","26":"44	2,652866740740740%	0,973445570370371%","27":"45	2,803001259259260%	1,040110948148150%","28":"46	2,969068666666670%	1,110981748148150%","29":"47	3,156124074074070%	1,185820370370370%","30":"48	3,368697525925930%	1,264979792592590%","31":"49	3,609218800000000%	1,351175303703700%","32":"50	3,879592607407410%	1,447712770370370%","33":"51	4,181723659259260%	1,557898059259260%","34":"52	4,517516666666670%	1,685037037037040%","35":"53	4,889542859259260%	1,831833422222220%","36":"54	5,303039540740740%	1,998582340740740%","37":"55	5,763910533333330%	2,184976770370370%","38":"56	6,278059659259260%	2,390709688888890%","39":"57	6,851390740740740%	2,615474074074070%","40":"58	7,488525570370370%	2,859618503703700%","41":"59	8,188957822222220%	3,126113955555560%","42":"60	8,950899140740740%	3,418587007407410%","43":"61	9,772561170370370%	3,740664237037040%","44":"62	10,652155555555600%	4,095972222222220%","45":"63	11,586371540740700%	4,487829540740740%","46":"64	12,565808770370400%	4,918322770370370%","47":"65	13,579544488888900%	5,389230488888890%","48":""};
    let sql = '';
    for (let i in list) {
        let info = list[i].replace(/\s+/g, ' ').split(/(\s)/);
        let out = [];
        for (let j in info) {
            if (info[j].trim() !== '') {
                out.push(info[j].trim().replace('%', ""));
            }
        }
        sql += 'INSERT INTO `tariffs` VALUES(NULL,\''+out[0]+'\',\''+out[1]+'\',\''+out[2]+'\',now(),now());';
    }
    console.log(sql);
        /!*

        {"0":"﻿18	0,298316%	0,142007%","1":"19	0,332577%	0,148081%","2":"20	0,367177%	0,153335%","3":"21	0,402304%	0,158481%","4":"22	0,438146%	0,164226%","5":"23	0,475161%	0,171269%","6":"24	0,514877%	0,180256%","7":"25	0,559089%	0,191820%","8":"26	0,609594%	0,206595%","9":"27	0,668189%	0,225215%","10":"28	0,736332%	0,248182%","11":"29	0,814135%	0,275476%","12":"30	0,901374%	0,306945%","13":"31	0,997824%	0,342437%","14":"32	1,103259%	0,381802%","15":"33	1,217191%	0,424737%","16":"34	1,338073%	0,470339%","17":"35	1,464094%	0,517555%","18":"36	1,593444%	0,565333%","19":"37	1,724311%	0,612619%","20":"38	1,855222%	0,658750%","21":"39	1,986052%	0,704630%","22":"40	2,117013%	0,751550%","23":"41	2,248317%	0,800803%","24":"42	2,380176%	0,853681%","25":"43	2,513610%	0,911223%","26":"44	2,652867%	0,973446%","27":"45	2,803001%	1,040111%","28":"46	2,969069%	1,110982%","29":"47	3,156124%	1,185820%","30":"48	3,368698%	1,264980%","31":"49	3,609219%	1,351175%","32":"50	3,879593%	1,447713%","33":"51	4,181724%	1,557898%","34":"52	4,517517%	1,685037%","35":"53	4,889543%	1,831833%","36":"54	5,303040%	1,998582%","37":"55	5,763911%	2,184977%","38":"56	6,278060%	2,390710%","39":"57	6,851391%	2,615474%","40":"58	7,488526%	2,859619%","41":"59	8,188958%	3,126114%","42":"60	8,950899%	3,418587%","43":"61	9,772561%	3,740664%","44":"62	10,652156%	4,095972%","45":"63	11,586372%	4,487830%","46":"64	12,565809%	4,918323%","47":"65	13,579544%	5,389230%"}
         *!/*/
});

let insurance = {
    life: function () {

        let date = $("#lifeInsurance-date").val();
        let sum = $("#lifeInsurance-sum").val().replace(/[^0-9\.]/g, '');
        let birth = $("#lifeInsurance-birth").val();
        let sex = $("#lifeInsurance-sex").val();
        let year = insurance.dateDiff(birth);

        $("#lifeInsurance-year").html(insurance.text(year));
        if (year >= 18 && year <= 65) {
            let prize = insurance.prize(sum, year, sex);
            $("#lifeInsurance-prize").html(((parseInt(prize * 100)) / 100) + ' ₸');
        } else {
            $("#lifeInsurance-prize").html('0.00 ₸');
        }
    },
    prize: function (sum, year, sex) {
        let data = JSON.parse($("#data").val());
        let prize = '0,00 ₸';
        for (let i in data) {
            if (data[i].year == year) {
                if (sex == 0) {
                    prize = (sum / 100) * data[i].male.replace(',', '.');
                } else {
                    prize = (sum / 100) * data[i].female.replace(',', '.');
                }
            }
        }
        return prize;
    },
    text: function (year) {
        if (year < 18 || year > 65) {
            return '<span style="color: red;">' + year + '</span>';
        }
        return '<span>' + year + '</span>';
    },
    dateDiff: function (date) {
        date = date.split('.');
        let dateold = new Date(date[2], date[1], date[0]);
        let datenew = new Date();
        let ynew = datenew.getFullYear();
        let mnew = datenew.getMonth();
        let dnew = datenew.getDate();
        let yold = dateold.getFullYear();
        let mold = dateold.getMonth();
        let dold = dateold.getDate();
        let diff = ynew - yold;
        if (mold > mnew) diff--;
        else if (mold == mnew) {
            if (dold > dnew) diff--;
        }
        return diff;
    }
}
